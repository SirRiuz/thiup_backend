<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"
        integrity="sha512-a+SUDuwNzXDvz4XrIcXHuCf089/iJAoN4lmrXJg18XnduKK6YlDHNRalv4yd1N40OKI80tFidF+rqTFKGPoWFQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>

        function deriveKey(passphrase) {
            var salt = CryptoJS.lib.WordArray.random(16);
            return CryptoJS.PBKDF2(passphrase, salt, {
                keySize: 32,
                iterations: 1000,
            });
        }

        function encrypt(plaintext) {
            var key = CryptoJS.lib.WordArray.random(16);
            let iv = CryptoJS.lib.WordArray.create(key.words.slice(0, 4));
            
                // Encrypt the plaintext
                // print("Key ->", base64.b64encode(key).decode())
                // print("Data ->", base64.b64encode(cipher_text).decode())
                // print("IV ->", base64.b64encode(iv).decode())

            var cipherText = CryptoJS.AES.encrypt(plaintext, key, {
                iv: iv,
                mode: CryptoJS.mode.CBC,
                padding: CryptoJS.pad.Pkcs7
            });

            
            console.log("key -> " + CryptoJS.enc.Base64.stringify(iv));
            console.log("data -> " + cipherText.toString())
            console.log("iv -> " + CryptoJS.enc.Base64.stringify(iv));
        }

        function decryptMessage(key, data, iv) {
            const decrypted = CryptoJS.AES.decrypt(
                {ciphertext: data},
                key,
                {
                    iv: iv,
                    mode: CryptoJS.mode.CBC,
                    padding: CryptoJS.pad.Pkcs7
                }
            );
            console.log(decrypted.toString(CryptoJS.enc.Utf8))
        }

        function decodePayload(payload) {
            const PAYLOAD = payload.split("").reverse().join("");
            const SPLIT_PAYLOAD = atob(PAYLOAD).split(":")
            return {
                key: SPLIT_PAYLOAD[0],
                iv: SPLIT_PAYLOAD[1],
            }
        }


        
        const { key, iv } = decodePayload("==QP9cXYDRjT4FVSvU2Yah0KidHWzYGR3wmO90zdFpkRrUzaK1WSzUmVP5WVxV2LHNVV")
        const REAL_DATA = "==QxnznCe98xkj/B+2SLH6KF".split("").reverse().join("");

        const k = CryptoJS.enc.Base64.parse(key)
        const data = CryptoJS.enc.Base64.parse(REAL_DATA)
        const i = CryptoJS.enc.Base64.parse(iv)
        


        decryptMessage(k, data, i)
        //encrypt("Esto es en js")
        

        // function deriveKey(passphrase, salts) {
        //     const salt = atob(salts)
        //     const key = CryptoJS.PBKDF2(passphrase, salt, { keySize: 32, iterations: 1000 }); // derivar la clave usando PBKDF2
        //     return { key: key.toString(), salt: salts }; // retornar la clave y la sal en formato Base64
        // }

        // function encryptMessage(message, key) {
        //     const encrypted = CryptoJS.AES.encrypt(message, key, { mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
        //     return encrypted.toString();
        // }
        
        // function decryptMessage(encryptedMessage, key) {
        //     const decrypted = CryptoJS.AES.decrypt(encryptedMessage, key, { mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
        //     return decrypted.toString(CryptoJS.enc.Utf8);
        // }

        // const derivedKey = deriveKey("key", "c2FsdA==");
        // console.log("Key -> " + derivedKey.key)
        // //console.log("Salts -> "  + derivedKey.salt)

        // //console.log("hello".toString(CryptoJS.enc.Base64))
        // // // console.log("Clave derivada:", derivedKey.key);
        // // // console.log("Sal:", derivedKey.salt);

        // // // Clave y mensaje de ejemplo
        // // const message = "Hola, este es un mensaje de ejemplo. :D";

        // // // Encriptar el mensaje usando la clave derivada
        // // const encryptedMessage = encryptMessage(message, derivedKey.key);
        // // console.log(encryptedMessage);
        // // console.log(decryptMessage(encryptedMessage, derivedKey.key))
    </script>
</body>

</html>